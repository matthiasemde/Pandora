when:
  branch: main
  event: push

steps:
  - name: check-flake
    image: nixos/nix:latest@sha256:d5cce2440bda1f966357732c06d86cb92368069fb52dfb6b2bae8725eea488a5
    commands:
      - nix --version
      - cd /home/matthias/infra
      - nix flake check --no-build

  - name: deploy
    image: nixos/nix:latest@sha256:d5cce2440bda1f966357732c06d86cb92368069fb52dfb6b2bae8725eea488a5
    commands:
      - cd /home/matthias/infra
      - /home/matthias/infra/tools/deploy.sh
    when:
      - evaluate: 'CI_COMMIT_BRANCH == "main"'
      - evaluate: 'CI_PIPELINE_EVENT == "push"'
